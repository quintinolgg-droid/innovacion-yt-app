<div class="d-flex flex-column vh-100">
  <app-nav />
  <main class="container-fluid flex-grow-1 p-4 bg-light">
    <h2 class="mb-4">√Årea de Videos</h2>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="videos-tab"
          data-bs-toggle="tab"
          data-bs-target="#videos"
          type="button"
          role="tab"
          aria-controls="videos"
          aria-selected="true"
        >
          üé¨ Videos Disponibles
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="favoritos-tab"
          data-bs-toggle="tab"
          data-bs-target="#favoritos"
          type="button"
          role="tab"
          aria-controls="favoritos"
          aria-selected="false"
        >
          ‚≠ê Mis Favoritos ({{ numberFav }})
        </button>
      </li>
    </ul>

    <div class="tab-content border border-top-0 bg-white p-3 shadow-sm" id="myTabContent">
      <div
        class="tab-pane fade show active"
        id="videos"
        role="tabpanel"
        aria-labelledby="videos-tab"
      >
        <h3 class="mb-3">Listado de Videos</h3>

        <div class="input-group mb-4">
          <input
            type="text"
            class="form-control"
            placeholder="Buscar videos..."
            [ngModel]="searchTermVideos"
            (ngModelChange)="searchTermVideos = $event"
            (keyup.enter)="searchVideos()"
          />
          <button class="btn btn-primary" type="button" (click)="searchVideos()">
            <i class="bi bi-search"></i>
            <span class="d-none d-sm-inline-block ms-1">Buscar</span>
          </button>
        </div>

        <div *ngIf="!isLoadingVideos" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
          <div *ngFor="let video of videos" class="col">
            <div class="card h-100 shadow-sm border-0">
              <a
                class="text-decoration-none"
                data-bs-toggle="modal"
                data-bs-target="#exampleModal"
                (click)="generarUrlSegura(video.url)"
              >
                <img
                  [src]="video.thumbnail"
                  [alt]="video.title"
                  class="card-img-top video-thumbnail"
                  style="width: 100%; height: 180px; object-fit: cover"
                />
              </a>

              <div class="card-body d-flex flex-column">
                <a [href]="video.url" target="_blank" class="text-decoration-none link-dark">
                  <h5 class="card-title text-truncate" title="{{ video.title }}">
                    {{ video.title }}
                  </h5>
                </a>
                <div class="mt-auto pt-2 d-flex">
                  <button
                    class="btn btn-outline-danger w-100 me-1"
                    (click)="markAsFavorite(video.videoid)"
                  >
                    <i class="bi bi-heart"></i> A√±adir a Favoritos
                  </button>

                  <button
                    class="btn btn-outline-primary"
                    title="Copiar enlace"
                    (click)="uiUtilService.copyLink(video.url)"
                  >
                    <i class="bi bi-link"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="favoritos" role="tabpanel" aria-labelledby="favoritos-tab">
        <h3 class="mb-3">Mis Videos Favoritos</h3>

        <div class="input-group mb-4">
          <input
            type="text"
            class="form-control"
            placeholder="Buscar favoritos..."
            [ngModel]="searchTermFavorites"
            (ngModelChange)="searchTermFavorites = $event"
            (keyup.enter)="searchFavorites()"
          />
          <button class="btn btn-primary" type="button" (click)="searchFavorites()">
            <i class="bi bi-search"></i>
            <span class="d-none d-sm-inline-block ms-1">Buscar</span>
          </button>
        </div>

        <div *ngIf="isLoadingFavorites" class="alert alert-info">Cargando favoritos...</div>

        <div *ngIf="!isLoadingFavorites && favorites.length === 0" class="alert alert-warning">
          A√∫n no tienes videos guardados como favoritos.
        </div>

        <div *ngIf="!isLoadingFavorites" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
          <div *ngFor="let fav of favorites" class="col">
            <div class="card h-100 shadow-sm border-0">
              <a (click)="generarUrlSegura(fav.url)" class="text-decoration-none">
                <img
                  [src]="fav.thumbnail"
                  [alt]="fav.title"
                  class="card-img-top video-thumbnail"
                  style="width: 100%; height: 180px; object-fit: cover"
                />
              </a>

              <div class="card-body d-flex flex-column">
                <a [href]="fav.url" target="_blank" class="text-decoration-none link-dark">
                  <h5 class="card-title text-truncate" title="{{ fav.title }}">
                    {{ fav.title }}
                  </h5>
                </a>
                <div class="d-flex mt-auto pt-2">
                  <button class="btn btn-danger w-100 me-1" (click)="unmarkAsFavorite(fav.videoid)">
                    <i class="bi bi-heart-fill"></i> Desmarcar
                  </button>
                  <button
                    class="btn btn-outline-primary"
                    title="Copiar enlace"
                    (click)="uiUtilService.copyLink(fav.url)"
                  >
                    <i class="bi bi-link"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div aria-live="polite" aria-atomic="true" class="position-relative">
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
      <div
        id="liveToastSuccess"
        class="toast align-items-center text-white bg-success border-0"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
        data-bs-delay="3000"
      >
        <div class="d-flex">
          <div class="toast-body fw-bold">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span id="toast-success-message">¬°Acci√≥n realizada con √©xito!</span>
          </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
      </div>

      <div
        id="liveToastError"
        class="toast align-items-center text-white bg-danger border-0"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
        data-bs-delay="5000"
      >
        <div class="d-flex">
          <div class="toast-body fw-bold">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span id="toast-error-message">Ocurri√≥ un error inesperado.</span>
          </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div
    class="modal fade"
    id="exampleModal"
    #modalRef
    tabindex="-1"
    aria-labelledby="exampleModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <iframe
            *ngIf="showVideo"
            class="w-100"
            [src]="videoUrlSegura"
            title="YouTube video player"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen
          ></iframe>
        </div>
      </div>
    </div>
  </div>
</div>
